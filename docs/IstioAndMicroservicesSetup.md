# Istio and Microservices Setup Documentation

This document details the step-by-step instructions to set up Istio on a Kubernetes cluster and deploy the microservices (including the **auth-service**) using Helm. It also explains how to install Istio, create necessary keys for JWT-based authentication, and expose microservices using an API gateway through Istio. Finally, it explains how to interact with the system using appropriate API endpoints.

---

## Prerequisites

- Kubernetes cluster up and running.
- Helm installed.
- Admin access to the Kubernetes cluster.
- Public and private keys for JWT authentication.

---

## Step 1: Install Istio

Istio provides a complete solution for managing microservices traffic, adding observability, and applying security policies. Here's how to install it in your Kubernetes cluster.

1. **Add Istio Helm Repository**

   ```bash
   helm repo add istio https://istio-release.storage.googleapis.com/charts
   helm repo update
   ```

2. **Create Istio Namespace**

   ```bash
   kubectl create namespace istio-system
   ```

3. **Install Istio Base**

   The Istio base is the foundational layer of Istio, including CRDs (Custom Resource Definitions).

   ```bash
   helm install istio-base istio/base -n istio-system --set defaultRevision=default
   ```

4. **Install Istiod (Istio control plane)**

   Istiod manages the Istio service mesh, handling configuration, routing, and policies.

   ```bash
   helm install istiod istio/istiod -n istio-system --wait
   ```

5. **Label the Namespace**

   You need to label the namespace where the microservices will run so that Istio injects sidecar proxies into each pod.

   ```bash
   kubectl label namespace default istio-injection=enabled
   ```

---

## Step 2: Set Up JWT Authentication

### 1. **Create Public-Private Keypair**

JWT tokens are signed using the private key. Here's how to generate RSA key pairs:

```bash
ssh-keygen -t rsa -b 2048 -f /path/to/your_custom_key_name
```

You will get two files: a private key and a public key.

### 2. **Convert Public Key to JWKS Format**

Use `jwk` to convert the public key to JWKS format:

```bash
npm install -g jwk
jwk import pem /path/to/public_key.pem --output /path/to/jwks.json
```

The **jwks.json** file will be used by the API Gateway for validating JWT tokens.

### 3. **Store Private Key in Kubernetes as Secret**

The private key is required by the **auth-service** to generate JWT tokens. We will store it securely as a Kubernetes secret:

```bash
kubectl create secret generic auth-secret-key --from-file=/path/to/private_key.pem
```

---

## Step 3: Deploy the Microservices

The microservices include **auth-service**, **file-picker-service**, **file-downloader-service**, **file-transformation-service**, **notification-service**, and **permission-service**. Here's how to deploy them using Helm.

### 1. **Deploy Auth-Service**

Navigate to the Helm directory:

```bash
cd helm/
```

Deploy the **auth-service** using Helm:

```bash
helm install auth-service auth-service/ -f values.yaml
```

### 2. **Deploy the Other Microservices**

Similarly, deploy the other microservices:

```bash
helm install file-picker-service file-picker-service/ -f values.yaml
helm install file-downloader-service file-downloader-service/ -f values.yaml
helm install file-transformation-service file-transformation-service/ -f values.yaml
helm install notification-service notification-service/ -f values.yaml
helm install permission-service permission-service/ -f values.yaml
```

### 3. **Install Istio Networking Layer**

The **istio-networking** Helm chart configures the Istio gateway and virtual services to route requests to the microservices.

```bash
helm install istio-networking istio-networking/ -f values.yaml
```

This will expose the services through the Istio ingress gateway.

---

## Step 4: Interact with the System

Once all microservices are deployed and running, users can interact with the system using an API gateway.

### 1. **Get the Token for User Authentication**

To communicate with the microservices, the user needs a JWT token generated by the **auth-service**. You can obtain the token by making a POST request to the `/token` endpoint.

Replace `<<ISTIO_GATEWAY_IP>>` with your Istio Gateway's IP address:

```bash
curl -X POST http://<<ISTIO_GATEWAY_IP>>/api/login -H "Content-Type: application/json" -d '{"username": "admin", "password": "adminpass"}'
```

You will receive a JWT token in response.

### 2. **Use the Token for Subsequent Requests**

Include the token in the Authorization header when making any API requests to the system. For example, to upload a file to the **file-picker-service**, you would use:

```bash
curl -X POST http://<<ISTIO_GATEWAY_IP>>/api/upload -H "Authorization: Bearer <<YOUR TOKEN>>" -F "file=@/path/to/file"
```

Replace `<<YOUR TOKEN>>` with the token received from the login request.

This document covers setting up Istio and microservices in a Kubernetes environment. The microservices are deployed using Helm, with JWT authentication enabled via auth-service. The current design spawns a separate SQLite database in auth-service for user details, but it can be improved by using a centralized PostgreSQL database shared across services for better data consistency.

With this architecture, you can ensure that each service communicates securely and scales independently, while Istio provides observability, security, and traffic management.

This concludes the documentation for setting up and interacting with the microservices in the Istio-enabled Kubernetes cluster.

---

## Step 5: Setting Up Database for Microservices

For services requiring a database, such as **auth-service** and **permission-service**, follow the steps to set up the database.

### 1. **Run PostgreSQL Database**

We recommend running the database as a separate StatefulSet with persistent volumes for data persistence. You can create a Kubernetes StatefulSet for PostgreSQL or use an external managed database solution such as AWS RDS.

### 2. **Configure Database in Microservices**

Each microservice that requires database access should have environment variables configured to point to the correct database instance. The connection string for the database will be specified in the `values.yaml` for each service:

```yaml
env:
  - name: DATABASE_URL
    value: "postgres://admin:password@<POSTGRES_IP>:5432/auth_service_db?sslmode=disable"
```

---

## Best Practices and Considerations

- **Centralized Database**: Use a centralized database for all microservices, running as a separate service. Do not place a database instance inside each microservice pod. Use a **StatefulSet** to ensure persistence and scalability.
- **Persistence**: Ensure all microservices that store data use persistent volumes in the Kubernetes cluster.
- **Scalability**: You can scale microservices independently by increasing the number of pods. For services like **file-picker-service** or **file-transformation-service**, ensure they can scale horizontally.
- **Istio Security**: Istio adds mTLS between services by default, ensuring secure communication.

---

By following these steps, you'll have a fully functioning Kubernetes cluster running Istio, JWT authentication, and all necessary microservices exposed through an Istio Gateway.